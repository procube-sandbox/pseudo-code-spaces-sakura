#cloud-config
# Cloud-init configuration for Workspaces

# ユーザー設定
users:
  - name: ubuntu
    uid: 1001
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
      - ${ssh_public_key}

# SSH設定（セキュリティ強化: パスワード認証無効、root接続無効）
ssh_pwauth: false
disable_root: true

# パッケージ更新
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - python3
  - python3-pip
  - git
  - openssh-server
  - ansible
  - iputils-ping
  - iptables
  - iptables-persistent

write_files:
  - path: /etc/environment
    content: |
      DOMAIN="${domain}"
      GITHUB_CLIENT_ID="${github_client_id}"
      GITHUB_CLIENT_SECRET="${github_client_secret}"
    append: true

runcmd:
  # ネットワークが完全に有効になるまで待機
  - sleep 10
  - timeout 60 bash -c 'until ping -c 1 8.8.8.8 >/dev/null 2>&1; do sleep 2; done'
  
  # SSHサービスの再起動
  - systemctl restart sshd
  
  # iptablesでファイアウォール設定
  # デフォルトポリシーをACCEPTに設定（後でINPUTをDROP）
  - iptables -P INPUT ACCEPT
  - iptables -P FORWARD DROP
  - iptables -P OUTPUT ACCEPT
  
  # 既存のルールをクリア
  - iptables -F
  - iptables -X
  
  # ループバックインターフェースを許可
  - iptables -A INPUT -i lo -j ACCEPT
  
  # 確立済み・関連する接続を許可
  - iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  
  # ICMP (ping) を許可
  - iptables -A INPUT -p icmp -j ACCEPT
  
  # SSH (ポート22) を許可
  - iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  
  # HTTP (ポート80) を許可
  - iptables -A INPUT -p tcp --dport 80 -j ACCEPT
  
  # HTTPS (ポート443) を許可
  - iptables -A INPUT -p tcp --dport 443 -j ACCEPT
  
  # その他の受信接続を拒否
  - iptables -A INPUT -j DROP
  
  # iptablesルールを保存
  - netfilter-persistent save
  
  # Create directory for application
  - mkdir -p /opt/workspaces
  - chown ubuntu:ubuntu /opt/workspaces

final_message: "Cloud-init completed. System is ready for Ansible provisioning."
